if (self.CavalryLogger) { CavalryLogger.start_js(["KpHW5"]); }

__d('AudioMimeTypes',[],(function a(b,c,d,e,f,g){var h={_extToMimeType:{aac:'audio/aac',mp1:'audio/mpeg',mp2:'audio/mpeg',mp3:'audio/mpeg',mpeg:'audio/mpeg',mpg:'audio/mpeg',ogg:'audio/mp4',mp4:'audio/mp4',m4a:'audio/mp4',wav:'audio/wav'},getMimeFromExt:function j(k){return this._extToMimeType[k];},isAudio:function j(k){return i(k)[0]==='audio';}};function i(j){return j.split('/');}f.exports=h;}),null);
__d('DataViewPolyfill',[],(function a(b,c,d,e,f,g){'use strict';function h(i,j,k){if(j===undefined){this.$DataViewPolyfill1=new Uint8Array(i);}else if(k===undefined){this.$DataViewPolyfill1=new Uint8Array(i,j);}else this.$DataViewPolyfill1=new Uint8Array(i,j,k);this.byteLength=this.$DataViewPolyfill1.byteLength;}h.prototype.getUint8=function(i){if(i>=this.$DataViewPolyfill1.length)throw new Error('Trying to read beyond bounds of DataViewPolyfill');return this.$DataViewPolyfill1[i];};h.prototype.getUint16=function(i,j){var k=this.getUint8(i),l=this.getUint8(i+1);return j?l*256+k:k*256+l;};h.prototype.getUint32=function(i,j){var k=this.getUint8(i),l=this.getUint8(i+1),m=this.getUint8(i+2),n=this.getUint8(i+3);return j?((n*256+m)*256+l)*256+k:((k*256+l)*256+m)*256+n;};h.isSupported=function(){return !!b.Uint8Array;};f.exports=h;}),null);
__d('getImageSize',['DataViewPolyfill'],(function a(b,c,d,e,f,g){var h=b.DataView||c('DataViewPolyfill');function i(m){return {width:m.getUint16(6,true),height:m.getUint16(8,true)};}function j(m){return {width:m.getUint32(16,false),height:m.getUint32(20,false)};}function k(m){var n=m.byteLength,o=2;while(o<n){var p=m.getUint16(o,false);o+=2;if(p==65472||p==65474){return {width:m.getUint16(o+5,false),height:m.getUint16(o+3,false)};}else o+=m.getUint16(o,false);}return null;}function l(m){var n=new h(m);if(n.getUint8(0)==255&&n.getUint8(1)==216)return k(n);if(n.getUint8(0)==71&&n.getUint8(1)==73&&n.getUint8(2)==70)return i(n);if(n.getUint8(0)==137&&n.getUint8(1)==80&&n.getUint8(2)==78&&n.getUint8(3)==71)return j(n);return null;}f.exports=l;l.gif=i;l.png=j;l.jpeg=k;}),null);
__d('ChatAutoSendPhotoUploader',['csx','fbt','invariant','ArbiterMixin','AsyncUploadRequest','AsyncRequest','AudioMimeTypes','DOM','Event','FileForm','FileFormResetOnSubmit','FileInput','FormSubmitOnChange','JpegResizer','MercuryAttachmentType','MercuryConstants','PhotosMimeType','PhotosUploadID','Run','SubscriptionsHandler','URI','arrayContains','getImageSize','getObjectValues','isEmpty','mixin'],(function a(b,c,d,e,f,g,h,i,j){'use strict';var k,l;function m(){return 'upload_'+c('PhotosUploadID').getNewID();}function n(p){return Array.prototype.reduce.call(p,function(q,r){var s=m();q[s]=r;return q;},{});}k=babelHelpers.inherits(o,c('mixin')(c('ArbiterMixin')));l=k&&k.prototype;function o(p,q,r,s){l.constructor.call(this);this.$ChatAutoSendPhotoUploader1=r;this.$ChatAutoSendPhotoUploader2=q;this.$ChatAutoSendPhotoUploader3=s;this.$ChatAutoSendPhotoUploader4=new (c('SubscriptionsHandler'))();this.$ChatAutoSendPhotoUploader5={};this.$ChatAutoSendPhotoUploader6={};this.$ChatAutoSendPhotoUploader7=false;this.$ChatAutoSendPhotoUploader8=p.getAttribute('action');this.$ChatAutoSendPhotoUploader9=new (c('FileForm'))(p,[c('FormSubmitOnChange'),c('FileFormResetOnSubmit')]);this.$ChatAutoSendPhotoUploader9.setAllowCrossOrigin(true);this.$ChatAutoSendPhotoUploader9.setUploadInParallel(true);if(s)this.$ChatAutoSendPhotoUploader9.setCustomHttpHeader('X-MSGR-Region',s);var t=c('DOM').find(p,"._4q60"),u=c('DOM').find(t,"._4q61");this.$ChatAutoSendPhotoUploader10=new (c('FileInput'))(t,u,q);this.$ChatAutoSendPhotoUploader4.addSubscriptions(c('Run').onBeforeUnload(this.onBeforeUnload.bind(this)),this.$ChatAutoSendPhotoUploader9.subscribe('submit',this.$ChatAutoSendPhotoUploader11.bind(this)),this.$ChatAutoSendPhotoUploader9.subscribe('success',this.$ChatAutoSendPhotoUploader12.bind(this)),this.$ChatAutoSendPhotoUploader9.subscribe('failure',this.$ChatAutoSendPhotoUploader13.bind(this)),this.$ChatAutoSendPhotoUploader9.subscribe('progress',this.$ChatAutoSendPhotoUploader14.bind(this)),c('Event').listen(u,'click',function(){if(this.$ChatAutoSendPhotoUploader15===undefined)this.$ChatAutoSendPhotoUploader16();if(this.$ChatAutoSendPhotoUploader15)if(c('JpegResizer').prepareResource)c('JpegResizer').prepareResource();this.inform('open');}.bind(this)));}o.prototype.$ChatAutoSendPhotoUploader16=function(){this.$ChatAutoSendPhotoUploader15=c('JpegResizer').isSupported();if(this.$ChatAutoSendPhotoUploader15)this.$ChatAutoSendPhotoUploader9.setPreprocessHandler(this.$ChatAutoSendPhotoUploader17.bind(this));};o.prototype.onBeforeUnload=function(){if(this.isUploading()&&!this.$ChatAutoSendPhotoUploader7)return i._("You haven't sent your message yet. Do you want to leave without sending?");};o.prototype.isUploading=function(){return !c('isEmpty')(this.$ChatAutoSendPhotoUploader5);};o.prototype.destroy=function(){this.$ChatAutoSendPhotoUploader4.release();this.$ChatAutoSendPhotoUploader9.destroy();this.$ChatAutoSendPhotoUploader5={};this.$ChatAutoSendPhotoUploader6={};};o.prototype.$ChatAutoSendPhotoUploader18=function(p,q){var r=this.$ChatAutoSendPhotoUploader19(p);if(q){r.preview_width=q.width;r.preview_height=q.height;}return r;};o.prototype.$ChatAutoSendPhotoUploader19=function(p){var q={upload_id:p,on_progress:function(r){this.$ChatAutoSendPhotoUploader4.addSubscriptions(this.subscribe('progress',r));}.bind(this),on_resizing_progress:function(r){this.$ChatAutoSendPhotoUploader4.addSubscriptions(this.subscribe('resize_progress',r));}.bind(this),on_success:function(r){this.$ChatAutoSendPhotoUploader4.addSubscriptions(this.subscribe('success',r));}.bind(this),upload_canceled:this.$ChatAutoSendPhotoUploader20.bind(this),attach_type:c('MercuryAttachmentType').PHOTO,preview_uploading:true};return q;};o.prototype.$ChatAutoSendPhotoUploader17=function(p,q){var r=p.getFile();if(!c('PhotosMimeType').isJpeg(r.type))return q(p);c('JpegResizer').getSingleton().resizeBlob(r,function(s,t,u){if(t)p.setFile(t);q(p);},this.$ChatAutoSendPhotoUploader21.bind(this,p));};o.prototype.$ChatAutoSendPhotoUploader11=function(){this.uploadFiles(this.$ChatAutoSendPhotoUploader2.files);return false;};o.prototype.$ChatAutoSendPhotoUploader22=function(p){if(!p)return false;var q=0;for(var r=0;r<p.length;r++){var s=p[r];q+=s.size;if(q>c('MercuryConstants').AttachmentMaxSize){this.inform('file-upload-error',{error:'size-exceeded'});return false;}if(s.type==='application/x-msdownload'||s.type==='application/x-msdownload-x64'){this.inform('file-upload-error',{error:'wrong-type'});return false;}}return true;};o.prototype.$ChatAutoSendPhotoUploader23=function(p,q){var r,s=this,t,u=arguments.length<=2||arguments[2]===undefined?{}:arguments[2];if(typeof FileReader!=='undefined'&&FileReader.prototype.readAsArrayBuffer&&q&&q.length===1){(function(){s.$ChatAutoSendPhotoUploader5[p]=p;u[p]=q[0];var v=new FileReader();v.onload=function(){this.inform('submit',{upload_id:p,preview_attachments:[this.$ChatAutoSendPhotoUploader18(p,c('getImageSize')(v.result))]});}.bind(s);v.onerror=function(){this.inform('submit',{upload_id:p,preview_attachments:[this.$ChatAutoSendPhotoUploader19(p)]});}.bind(s);if(q[0].size){v.readAsArrayBuffer(q[0]);}else{var w=babelHelpers['extends']({},s.$ChatAutoSendPhotoUploader18(p,q[0].source),{preview_url:q[0].preview_url});s.inform('submit',{upload_id:p,preview_attachments:[w]});}})();}else (function(){var v=[];if(!q){s.$ChatAutoSendPhotoUploader5[p]=p;s.$ChatAutoSendPhotoUploader1.value=p;v.push(s.$ChatAutoSendPhotoUploader19(p));}else{var w=Object.keys(u);if(w.length>0){w.forEach(function(z){this.$ChatAutoSendPhotoUploader5[z]=p;v.push(this.$ChatAutoSendPhotoUploader19(z));}.bind(s));}else for(var x=0;x<q.length;++x){var y=m();u[y]=q[x];s.$ChatAutoSendPhotoUploader5[y]=p;v.push(s.$ChatAutoSendPhotoUploader19(y));}}s.inform('submit',{upload_id:p,preview_attachments:v});})();if(Object.keys(u).length>0)this.$ChatAutoSendPhotoUploader9.setFiles(u);};o.prototype.$ChatAutoSendPhotoUploader12=function(event,p){var q=this.$ChatAutoSendPhotoUploader24(p);if(this.$ChatAutoSendPhotoUploader5[q]){var r=this.$ChatAutoSendPhotoUploader5[q];delete this.$ChatAutoSendPhotoUploader5[q];var s=p.response.getPayload();if(!this.$ChatAutoSendPhotoUploader6[r])this.$ChatAutoSendPhotoUploader6[r]=[];this.$ChatAutoSendPhotoUploader6[r].push({id:q,audio_id:s.metadata[0].audio_id,image_id:s.metadata[0].image_id,file_id:s.metadata[0].file_id,gif_id:s.metadata[0].gif_id,video_id:s.metadata[0].video_id});this.inform('success',{upload_id:q});if(!this.$ChatAutoSendPhotoUploader25(r))this.$ChatAutoSendPhotoUploader26(r);this.$ChatAutoSendPhotoUploader10.clear();this.$ChatAutoSendPhotoUploader2=this.$ChatAutoSendPhotoUploader10.getInput();}};o.prototype.$ChatAutoSendPhotoUploader26=function(p){!this.$ChatAutoSendPhotoUploader25(p)||j(0);this.$ChatAutoSendPhotoUploader6[p].sort(function(q,r){return q.id<r.id?-1:1;});this.inform('all-uploads-completed',{upload_id:p,audio_ids:this.$ChatAutoSendPhotoUploader6[p].map(function(q){return q.audio_id;}),image_ids:this.$ChatAutoSendPhotoUploader6[p].map(function(q){return q.image_id;}),file_ids:this.$ChatAutoSendPhotoUploader6[p].map(function(q){return q.file_id;}),gif_ids:this.$ChatAutoSendPhotoUploader6[p].map(function(q){return q.gif_id;}),video_ids:this.$ChatAutoSendPhotoUploader6[p].map(function(q){return q.video_id;})});delete this.$ChatAutoSendPhotoUploader6[p];};o.prototype.$ChatAutoSendPhotoUploader14=function(event,p){this.inform('progress',{upload_id:p.upload.getName(),event:p.event});};o.prototype.$ChatAutoSendPhotoUploader21=function(p,event){this.inform('resize_progress',{upload_id:p.getName(),event:event});};o.prototype.$ChatAutoSendPhotoUploader25=function(p){return c('arrayContains')(c('getObjectValues')(this.$ChatAutoSendPhotoUploader5),p);};o.prototype.$ChatAutoSendPhotoUploader13=function(event,p){var q=this.$ChatAutoSendPhotoUploader24(p);this.$ChatAutoSendPhotoUploader27(q,'last-upload-failed',p.additionalParams);this.$ChatAutoSendPhotoUploader10.clear();this.$ChatAutoSendPhotoUploader2=this.$ChatAutoSendPhotoUploader10.getInput();return false;};o.prototype.$ChatAutoSendPhotoUploader20=function(p){this.$ChatAutoSendPhotoUploader27(p,'last-upload-canceled');};o.prototype.$ChatAutoSendPhotoUploader27=function(p,q,r){if(!this.$ChatAutoSendPhotoUploader5[p])return;var s=this.$ChatAutoSendPhotoUploader5[p];delete this.$ChatAutoSendPhotoUploader5[p];if(!this.$ChatAutoSendPhotoUploader25(s))if(this.$ChatAutoSendPhotoUploader6[s]){this.$ChatAutoSendPhotoUploader26(s);}else this.inform(q,babelHelpers['extends']({upload_id:s},r));};o.prototype.$ChatAutoSendPhotoUploader24=function(p){if(p.upload){return p.upload.getName();}else return p.response&&p.response.getPayload().uploadID||p.getName();};o.prototype.uploadFiles=function(p){if(!this.$ChatAutoSendPhotoUploader22(p))return;var q=m(),r=void 0;if(p.length===1){var s;r=(s={},s[q]=p[0],s);}else r=n(p);var t=new (c('AsyncUploadRequest'))(this.$ChatAutoSendPhotoUploader8).setAllowCrossOrigin(true).setAllowCrossPageTransition(this.$ChatAutoSendPhotoUploader7).setRelativeTo(this.$ChatAutoSendPhotoUploader9.getRoot()).setFiles(r);if(this.$ChatAutoSendPhotoUploader3)t.setCustomHttpHeader('X-MSGR-Region',this.$ChatAutoSendPhotoUploader3);var u=Array.prototype.some.call(p,function(v){return c('AudioMimeTypes').isAudio(v.type);});if(u)t.setData({voice_clip:true});this.$ChatAutoSendPhotoUploader4.addSubscriptions(t.subscribe('success',function(event,v){this.$ChatAutoSendPhotoUploader12(event,{upload:v,response:v.getResponse()});}.bind(this)),t.subscribe('failure',this.$ChatAutoSendPhotoUploader13.bind(this)));t.send();this.$ChatAutoSendPhotoUploader23(q,p,r);};o.prototype.uploadURL=function(p){var q=m(),r=p.errorDialogParams;delete p.errorDialogParams;var s=new (c('AsyncRequest'))().setURI(new (c('URI'))(this.$ChatAutoSendPhotoUploader8).getPath()).setAllowCrossPageTransition(this.$ChatAutoSendPhotoUploader7).setData(babelHelpers['extends']({},p,{attach_id:q})).setErrorHandler(function(t){this.$ChatAutoSendPhotoUploader13(null,{additionalParams:{errorDialogParams:r},response:{getPayload:function u(){return {uploadID:q};}}});}.bind(this)).setHandler(function(t){this.$ChatAutoSendPhotoUploader12(null,{response:t});}.bind(this));s.send();this.$ChatAutoSendPhotoUploader23(q,[p]);};o.prototype.setAllowCrossPage=function(p){this.$ChatAutoSendPhotoUploader7=p;this.$ChatAutoSendPhotoUploader9.setAllowCrossPageTransition(p);};f.exports=o;}),null);